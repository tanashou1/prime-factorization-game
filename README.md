# 素因数分解ゲーム (Prime Factorization Game)

**Play the game here: https://tanashou1.github.io/prime-factorization-game/**

素因数分解をベースにした数字パズルゲームです。タイルを動かして約数で割り、連鎖させてスコアを競います。

## 📝 ゲーム概要

n×nマスの盤面上で、数字タイルをスライドさせて操作するパズルゲームです。タイル同士が約数関係にあるとき、合体して割り算が実行されます。タイルの値が1になると消滅し、スコアを獲得できます。連鎖反応を活用して高得点を目指しましょう。

## 🎮 基本ルール

### タイルの移動
- **キーボード操作**: 矢印キー（↑↓←→）でタイルをスライド
- **タッチ操作**: スワイプで特定のタイル、または全タイルを動かす
  - タイルに触れてスワイプ: そのタイルのみが移動
  - 空きマスに触れてスワイプ: すべてのタイルが同時移動

### タイルの合体ルール

#### 1. 基本的な合体（約数による割り算）
片方のタイルがもう片方の約数である場合、合体が発生します：
- **約数タイル（小）**: 消滅
- **被約数タイル（大）**: 割り算の結果（大 ÷ 小）に変化
- **結果の位置**: 大きい方のタイルがあった場所

**例**: タイル「3」とタイル「147」が隣接
- 3は147の約数（147 ÷ 3 = 49）
- タイル「3」が消滅
- タイル「147」が「49」に変化

#### 2. 同じ値での消滅
同じ値のタイルが隣接すると、両方とも消滅します：
- 両タイルが消滅
- それぞれの値がスコアに加算

**例**: 「7」と「7」が隣接 → 両方消滅、スコア +14

#### 3. 完全累乗での特殊消滅
同じ値のタイルが完全累乗（平方数または立方数）の場合、特殊なアニメーションとともに消滅します：
- **平方数**: 4, 9, 16, 25, 36, 49, 64, 81, 100...（n²の形）
- **立方数**: 8, 27, 64, 125, 216...（n³の形）

**例**: 「49」と「49」が隣接（49 = 7²）→ 特殊なパワー消滅エフェクトで消滅

#### 4. 複数タイル同時因数分解
中央のタイルが、隣接する複数のタイルによって因数分解できる場合：
- 中央タイル = 因数1 × 因数2 × ... × 因数n
- 各因数が異なる隣接タイルを割る
- 関与したすべてのタイルが影響を受ける

**例**: 中央に「12」、隣接に「3」と「4」
- 12 = 3 × 4
- タイル「12」→ 12 ÷ (3 × 4) = 1 → 消滅
- タイル「3」→ 3 ÷ 3 = 1 → 消滅
- タイル「4」→ 4 ÷ 4 = 1 → 消滅

### 連鎖反応
合体後、自動的に隣接タイルとの約数関係をチェックし、連続して合体が発生します：
1. 小さい値のタイルから順に処理
2. 隣接タイルとの約数関係を確認
3. 合体可能な組み合わせがある限り繰り返し
4. 連鎖回数に応じてスコア倍率が上昇（2^n倍）

**連鎖の例**:
```
初期状態: [2] [3] [6]
↓
1回目: 2と6が合体 → [3] [3]
↓
2回目: 3と3が消滅 → []（全消滅）
```

### タイルの消滅
以下の条件でタイルが消滅します：
- 値が1になった時
- 同じ値のタイル同士が隣接した時
- 合体で約数側のタイルになった時

### スコアリング
- タイルが消滅する際、そのタイルの元の値がスコアに加算
- 連鎖が発生すると、連鎖回数に応じてスコアが倍増：
  - 1連鎖目: 1倍
  - 2連鎖目: 2倍
  - 3連鎖目: 4倍
  - n連鎖目: 2^(n-1)倍

### 新しいタイルの出現
以下の条件で新しいタイルが出現します：
- k回移動した時（kはパラメータ設定可能）
- タイルが消滅した時
- 「タイル生成」ボタンを押した時（手動生成）

## ⚙️ ゲームパラメータ

ゲーム画面下部で以下のパラメータを調整できます：

| パラメータ | 記号 | 説明 | デフォルト値 | 範囲 |
|----------|------|------|------------|------|
| ボードサイズ | n | 盤面のサイズ（n×nマス） | 4 | 3～8 |
| 初期タイル数 | m | ゲーム開始時のタイル数 | 2 | 1～10 |
| 新タイル出現間隔 | k | k回移動ごとに新タイルが出現 | 3 | 1～10 |
| 最大素数 | p | タイル生成に使う素数の最大値 | 7 | 2～19 |

### タイルの数値生成ルール
- p以下の素数をリストアップ（例: p=7 → [2, 3, 5, 7]）
- ランダムに1～3個の素数を選択
- それらの積を新タイルの値とする

**例**: p=7の場合
- 2 × 3 = 6
- 5 × 7 = 35
- 2 × 2 × 3 = 12
など多様なタイルが生成される

## 🎨 ゲームの特徴

### アニメーション効果
- **タイル出現**: フェードインアニメーション
- **タイル移動**: スムーズなスライドアニメーション
- **合体・消滅**: ハイライト表示後、消滅アニメーション
- **完全累乗消滅**: 平方数・立方数の特殊エフェクト
- **連鎖カウンター**: 連鎖回数の表示

### 操作性
- キーボードでの高速プレイ
- タッチデバイスでの直感的な操作
- アニメーション中の誤操作防止
- 個別タイル移動と全体移動の使い分け

### バランス調整
- パラメータのリアルタイム変更
- リセットボタンで設定反映
- プレイスタイルに合わせたカスタマイズ

## 🎯 ゲーム攻略のヒント

### 基本戦略
1. **小さい数を活用**: 2、3、5などの小さい素数タイルは、多くのタイルと合体可能
2. **連鎖を狙う**: 連鎖が発生するとスコアが倍増（2のべき乗倍）
3. **同じ値を隣接**: 同じ値のタイルを隣接させると両方消滅してスコア獲得
4. **完全累乗を意識**: 平方数（4, 9, 16, 25...）のペアは特殊消滅

### 高スコアのコツ
- **連鎖の最大化**: 一度の移動で複数回連鎖させるほど高スコア
- **複数タイル因数分解**: 3つ以上のタイルを同時に因数分解できる配置を作る
- **盤面管理**: タイルを詰めすぎず、連鎖の余地を残す
- **計画的な移動**: 次に出現するタイルのためのスペースを確保

### パラメータ調整のコツ
- **初心者向け**: n=4, m=2, k=5, p=5（少ないタイル、小さい数値）
- **標準**: n=4, m=2, k=3, p=7（デフォルト設定）
- **上級者向け**: n=5, m=3, k=2, p=11（多いタイル、大きい数値、速いペース）
- **カオスモード**: n=6, m=5, k=1, p=19（最大難易度）

## 📚 参考情報

### 数学的背景
このゲームは以下の数学的概念を活用しています：
- **素因数分解**: すべての自然数は素数の積で一意に表現できる
- **約数**: ある数を割り切れる数（例: 6の約数は1, 2, 3, 6）
- **完全累乗**: n²（平方数）やn³（立方数）の形の数
- **エラトステネスの篩**: 素数を効率的に列挙するアルゴリズム

### ゲームのバージョン情報
現在のバージョン: **v2.1.2**

主要な機能追加・改善履歴：
- v2.x: 複数タイル因数分解、完全累乗消滅の実装
- v1.6.x: 連鎖反応ロジックの完全リライト
- v1.5.x: 各種バグ修正、アニメーション改善
- v1.x: 基本ゲームシステムの実装

詳細な変更履歴は各種ドキュメント（BUGFIX_SUMMARY.md等）を参照してください。

## 🔧 技術仕様

### 技術スタック
- **フレームワーク**: React 19.2.0 + TypeScript
- **ビルドツール**: Vite 7.2.4
- **テストフレームワーク**: Vitest 4.0.18（ユニットテスト）、Playwright 1.58.1（E2Eテスト）
- **スタイリング**: CSS（カスタムアニメーション）
- **リンター**: ESLint 9.39.1

### アーキテクチャ

#### コアモジュール
1. **gameLogic.ts**: ゲームロジックのコア関数
   - 素数生成（エラトステネスの篩）
   - タイル値のランダム生成
   - 約数判定
   - 完全累乗判定（平方数・立方数）
   - 複数タイル因数分解の判定

2. **chainReactionLogic.ts**: 連鎖反応処理
   - 単一イテレーションの処理
   - 完全な連鎖反応の処理
   - スコア計算（連鎖倍率適用）
   - 処理順序の制御（小さい値から）

3. **simpleTileRemoval.ts**: 移動後のタイル処理
   - 移動したタイルの隣接判定
   - 同値消滅の判定
   - 約数関係による合体処理

4. **types.ts**: 型定義
   - Tile: タイルの状態とアニメーションフラグ
   - GameState: ゲーム全体の状態
   - GameParams: ゲームパラメータ

#### UIコンポーネント
- **Game.tsx**: メインゲームコンポーネント
  - ゲーム状態管理
  - タイル移動ロジック
  - アニメーション制御
  - イベントハンドリング（キーボード・タッチ）
  - パラメータ設定UI

- **App.tsx**: アプリケーションルート

### アニメーション制御
アニメーション中の状態管理により、スムーズな視覚効果と誤操作防止を実現：
- `isAnimatingRef`: アニメーション実行中フラグ（再入防止）
- `isMoving`: タイル移動アニメーション
- `isDividing`: 割り算実行時のエフェクト
- `isChaining`: 連鎖反応中のエフェクト
- `isDisappearing`: 消滅アニメーション
- `isPowerEliminating`: 完全累乗消滅の特殊エフェクト
- `mergeHighlight`: 合体時のハイライト
- `isHighlighting`: 相互作用前の予告ハイライト

### タイル処理フロー
1. **移動フェーズ**
   - ユーザー入力（キーボードまたはタッチ）
   - タイルの移動方向決定
   - ステップごとの位置更新（100msごと）
   - 合体判定と実行

2. **ハイライトフェーズ**（Issue #35対応）
   - 相互作用するタイルをハイライト表示（400ms）
   - ユーザーに何が起きるか予告

3. **エフェクトフェーズ**
   - 実際の値変更とエフェクト表示
   - 消滅アニメーション実行（800ms）

4. **連鎖フェーズ**
   - 自動的な連鎖反応処理
   - 複数イテレーションの実行

5. **クリーンアップ**
   - アニメーションフラグのクリア（1300ms後）
   - 値が0のタイルの削除
   - 新タイル生成の判定

### バグ修正履歴
プロジェクトには詳細なバグ修正記録があります：
- **BUGFIX_SUMMARY.md**: 主要なバグ修正の概要
- **BUGFIX_v1.5.6.md**: v1.5.6の修正内容
- **BUG_FIX_SUMMARY.md**: 総合的なバグ修正サマリー
- **REWRITE_v1.6.0.md**: v1.6.0での大規模リライト
- **TILE_MERGING_SPEC.md**: タイル合体の詳細仕様書

## 開発 (Development)

### 開発環境のセットアップ

#### 必要な環境
- Node.js (推奨: v18以上)
- npm (Node.jsに同梱)

#### セットアップ手順
```bash
# リポジトリのクローン
git clone https://github.com/tanashou1/prime-factorization-game.git
cd prime-factorization-game

# 依存関係のインストール
npm install
```

### 開発サーバー (Dev Server)
```bash
npm run dev
```
ローカル開発サーバーが起動します（通常は http://localhost:5173）

### ビルド (Build)
```bash
npm run build
```
- TypeScriptのコンパイル実行
- 本番用の最適化されたファイルを`dist/`に生成

### プレビュー (Preview)
```bash
npm run preview
```
ビルド結果をローカルでプレビュー

### リンター (Linter)
```bash
npm run lint
```
ESLintでコード品質をチェック

### テスト (Testing)

#### ユニットテスト (Unit Tests with Vitest)
```bash
npm run test        # ウォッチモード（変更を監視して自動実行）
npm run test:run    # 1回だけ実行
npm run test:ui     # UIモードで実行（ブラウザで結果を表示）
```

**主なテストケース**:
- `gameLogic.test.ts`: コアロジックのテスト
- `chainReactionLogic.test.ts`: 連鎖反応のテスト
- `simpleTileRemoval.test.ts`: タイル削除処理のテスト
- `collision.test.ts`: 衝突判定のテスト
- `equalValueElimination.test.ts`: 同値消滅のテスト
- `bug_*.test.ts`: 特定のバグ修正の回帰テスト

#### E2Eテスト (E2E Tests with Playwright)
```bash
npm run test:e2e           # E2Eテストを実行
npm run test:e2e:ui        # UIモードで実行
npm run test:e2e:debug     # デバッグモードで実行
npm run playwright:codegen # テストコードを生成（記録機能）
```

E2Eテストはブラウザ上で実際のゲームプレイをシミュレートして、UIとゲームロジックの統合をテストします。

### プロジェクト構成
```
prime-factorization-game/
├── src/
│   ├── main.tsx                    # エントリーポイント
│   ├── App.tsx                     # アプリケーションルート
│   ├── Game.tsx                    # メインゲームコンポーネント
│   ├── Game.css                    # ゲームのスタイル
│   ├── types.ts                    # 型定義
│   ├── gameLogic.ts                # コアゲームロジック
│   ├── chainReactionLogic.ts       # 連鎖反応処理
│   ├── simpleTileRemoval.ts        # タイル削除処理
│   └── *.test.ts                   # ユニットテスト
├── tests/                          # E2Eテスト
├── public/                         # 静的アセット
├── package.json                    # プロジェクト設定
├── vite.config.ts                  # Vite設定
├── tsconfig.json                   # TypeScript設定
├── playwright.config.ts            # Playwright設定
└── eslint.config.js                # ESLint設定
```

### コーディング規約
- TypeScript strictモードを使用
- Reactの関数コンポーネントとHooksを使用
- ESLintルールに準拠
- すべての新機能にテストを追加
- バグ修正には回帰テストを追加

### デプロイ
本プロジェクトはGitHub Pagesにデプロイされています。
- メインブランチへのプッシュで自動デプロイ（GitHub Actions）
- デプロイURL: https://tanashou1.github.io/prime-factorization-game/

## MCP (Model Context Protocol) 設定

このプロジェクトはPlaywright MCPサーバーをサポートしています。

### Claude Desktopでの使用

`claude_desktop_config.json`を参照して、Claude Desktopの設定ファイル（通常は`~/Library/Application Support/Claude/claude_desktop_config.json`）に以下のようにMCPサーバーを追加してください：

```json
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["-y", "@executeautomation/playwright-mcp-server"],
      "env": {
        "PLAYWRIGHT_HEADLESS": "true",
        "PLAYWRIGHT_BASE_URL": "http://localhost:5173"
      }
    }
  }
}
```

これにより、Claude DesktopからPlaywrightを使用してブラウザの自動化やE2Eテストを実行できるようになります。
